<div id="dist"></div>
<script>
async function fetchDistance() {
  let res = await fetch("distance.txt?cache=" + Math.random());
  document.getElementById('dist').textContent = (await res.text()) + " cm";
}
setInterval(fetchDistance, 2000);
fetchDistance();
</script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dynamic Containers with Firebase</title>
    <style>
      body{
        font-family:"Calibri","Helvetica Neue",Arial,sans-serif;
        max-width:900px;margin:2rem auto;background:#fff8f0;color:#333;
        position: relative;
      }
      h1{
        text-align:center;font-size:2rem;margin-bottom:1rem;color:#ff6f61;
      }
      /* MODIFIED: Top Tools Wrapper */
      .tools-wrapper {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }
      .tool-container {
        position: relative;
      }
      .tool-toggle-btn {
        padding: 8px 12px;
        font-size: 14px;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      .stopwatch-toggle-btn { background: #2196F3; }
      .calc-toggle-btn { background: #b39ddb; }

      /* Stopwatch Styles */
      .stopwatch{
        display: none; /* Hidden by default */
        position: absolute;
        top: 40px; /* Position below the button */
        left: 50%;
        transform: translateX(-50%);
        background: #f0f0f0;
        padding: 15px; /* Increased padding */
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        z-index: 10;
      }
      /* MODIFIED: Bigger time display */
      #time-display{
        font-size: 2.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 12px;
        display: block;
        min-width: 180px; /* Give it space */
        font-family: 'Courier New', Courier, monospace;
      }
      /* MODIFIED: Bigger buttons */
      .stopwatch-btn{
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        border-radius: 6px;
        color: #fff;
        margin: 0 5px;
        width: 70px; /* Give buttons a consistent width */
      }
      .start-pause-btn.running {
        background: #ffcc80; /* Pause color */
      }
      .start-pause-btn {
        background: #a5d6a7; /* Start color */
      }
      .reset-btn{ background: #ef9a9a; }

      /* Calculator Styles */
      .calculator {
        display: none; /* Hidden by default */
        position: absolute;
        top: 40px; /* Position below the button */
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        border: 2px solid #333;
        border-radius: 10px;
        background: #d3d3d3;
        padding: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 10;
      }
      .calculator-screen {
        width: 100%;
        height: 60px;
        background: #c9e4c9;
        border: 2px solid #333;
        border-radius: 5px;
        margin-bottom: 15px;
        padding: 0 10px;
        font-size: 2rem;
        text-align: right;
        box-sizing: border-box;
        overflow: hidden;
      }
      .calculator-keys {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
      }
      .calc-btn {
        padding: 15px 5px;
        font-size: 1.1rem;
        border-radius: 5px;
        border: 1px solid #999;
        cursor: pointer;
        background: #f0f0f0;
        box-shadow: 0 2px #999;
      }
      .calc-btn:active {
        box-shadow: none;
        transform: translateY(2px);
      }
      .calc-btn.operator { background: #ff9800; color: white; }
      .calc-btn.function { background: #777; color: white; }
      .calc-btn.clear, .calc-btn.del { background: #ef5350; color: white; }
      .calc-btn.equals { grid-column: span 2; background: #4caf50; color: white; }


      .container-controls{
        display:flex;
        justify-content: flex-end; /* Move to right */
        gap:10px;
        margin-bottom:15px;
      }
      .control-btn{
        padding:6px 12px;border:none;border-radius:6px;font-size:18px;color:#fff;
        cursor:pointer;transition:.2s;width:40px;height:40px;text-align:center;
      }
      .control-btn.add{background:#a5d6a7;}
      .control-btn.remove{background:#ef9a9a;}
      .control-btn:hover{transform:scale(1.05);}
      .zone{
        border:2px solid #ffb347;border-radius:10px;margin-bottom:15px;overflow:hidden;
        box-shadow:0 2px 6px rgba(0,0,0,.1);background:#fff4e6;
      }
      .zone-header{
        display:flex;align-items:center;gap:8px;padding:12px 14px;background:#ffb347;
        color: #c62828;cursor:pointer;font-weight:bold;font-size:1.1rem;
      }
      .zone .plus{
        width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;
        border:1px solid #ff9800;border-radius:4px;font-weight:bold;background:#ffcc80;color:#333;
        transition:transform .15s;
        font-size: 1.2rem;
        line-height: 1;
      }
      .zone-content{display:none;padding:12px 14px 16px;background:#fffef8;}
      .zone[open] .zone-content{display:block;}
      .mini-btn,.add-btn,.graph-btn{
        padding:6px 10px;font-size:13px;cursor:pointer;border:none;border-radius:6px;
        transition:transform .1s,background .2s;color:#fff;
      }
      .add-btn{background:#f48fb1;width:40px;height:40px;font-size:18px;}
      .mini-btn.add-col{background:#80cbc4;} /* + Column */
      .mini-btn.add-row{background:#90caf9;} /* + Row */
      .mini-btn.del-col{background:#f48fb1;} /* - Column */
      .mini-btn.del-row{background:#ffcc80;} /* - Row */
      .graph-btn{background:#b39ddb;width:auto;height:auto;padding:6px 10px;font-size:13px;}
      .graph-btn.note-btn { background: #64b5f6; } /* Light blue for Note button */
      .mini-btn:hover,.add-btn:hover,.graph-btn:hover{transform:scale(1.05);}
      
      .dropdown-controls{
        display:flex;
        justify-content: flex-end; /* Move to right */
        gap:.5rem;
        margin:8px 0;
        flex-wrap:wrap;
      }
      .table-toolbar {
        display:flex;
        justify-content: flex-end; /* Move to right */
        gap:.5rem;
        margin:8px 0;
        flex-wrap:wrap;
      }
      .section{
        border:1px solid #ddd;border-radius:6px;margin-bottom:10px;overflow:hidden;
      }
      .header{
        display:flex;align-items:center;gap:8px;padding:12px 14px;background:#ffe0b2;
        cursor:pointer;border:none;font-weight:bold;width:100%;
      }
      .header .plus{
        width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;
        border:1px solid #ff9800;border-radius:4px;background:#ffcc80;font-weight:bold;
        font-size: 1.1rem;
        line-height: 1;
      }
      .content{padding:10px 14px 14px;display:none;}
      .section[open] .content{display:block;}
      .table-title{
        font-size:1rem;font-weight:bold;margin:8px 0 4px;text-align:center;color:#4a148c;
      }
      .table-container{
        overflow-x:auto;border:2px solid #ccc;border-radius:5px;margin-top:5px;
      }
      table{
        border-collapse:collapse;width:100%;
      }
      table.wide{min-width:1000px;}
      table,th,td{border:3px solid #000;}
      th,td{padding:6px;text-align:center;font-size:14px;}
      td[contenteditable="true"]{cursor:text;}
      .table-top td,.table-top th{background:#ffd6e7;}
      .table-bottom td,.table-bottom th{background:#e6d6ff;}
      .date-row td{
        background:#ffcccc!important;cursor:pointer;
        -webkit-user-select:none; /* Safari compatibility */
        user-select:none;
        font-size:7px;
      }
      .graph-wrap{
        margin-top:8px;padding:8px;background:#fff;border:2px dashed #b39ddb;border-radius:8px;
        display:none;
      }
      /* NEW: Note area styles */
      .note-wrap {
          display: none; /* Hidden by default */
          margin-top: 8px;
      }
      .note-area {
          width: 100%;
          min-height: 80px;
          box-sizing: border-box;
          border: 1px solid #ccc;
          border-radius: 5px;
          padding: 8px;
          font-family: inherit;
          font-size: 14px;
          resize: vertical;
      }
      /* MODIFIED: Different editing styles for container vs dropdown titles */
      .editing-container {
        outline: 2px dashed #ff6f61;
        background: #fbe0bc; /* Darker orange-tinted background */
      }
      .editing-dropdown {
        outline: 2px dashed #ff6f61;
        background: #eef2ff; /* A light blue/purple background */
      }
      /* Custom Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 20px 30px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      }
      .modal-buttons {
        margin-top: 20px;
      }
      .modal-buttons button {
        padding: 10px 20px;
        margin: 0 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      }
      #confirm-yes-btn { background-color: #ef9a9a; color: white; }
      #confirm-no-btn { background-color: #ccc; }
    </style>
</head>
<body>
    <!-- MOVED: Tools are now at the top of the body -->
    <div class="tools-wrapper">
        <div class="tool-container">
            <button class="tool-toggle-btn stopwatch-toggle-btn">Stopwatch</button>
            <div class="stopwatch">
                <span id="time-display">00:00.00</span>
                <div>
                    <button id="start-pause-btn" class="stopwatch-btn start-pause-btn">Start</button>
                    <button id="reset-btn" class="stopwatch-btn reset-btn">Reset</button>
                </div>
            </div>
        </div>
        <div class="tool-container">
            <button class="tool-toggle-btn calc-toggle-btn">Calculator</button>
            <div class="calculator">
                <input type="text" class="calculator-screen" value="" disabled />
                <div class="calculator-keys">
                    <button type="button" class="calc-btn function" value="sin">sin</button>
                    <button type="button" class="calc-btn function" value="cos">cos</button>
                    <button type="button" class="calc-btn function" value="tan">tan</button>
                    <button type="button" class="calc-btn del" value="DEL">DEL</button>
                    <button type="button" class="calc-btn clear" value="AC">AC</button>
                    
                    <button type="button" class="calc-btn" value="7">7</button>
                    <button type="button" class="calc-btn" value="8">8</button>
                    <button type="button" class="calc-btn" value="9">9</button>
                    <button type="button" class="calc-btn operator" value="/">&divide;</button>
                    <button type="button" class="calc-btn function" value="sqrt">&radic;</button>

                    <button type="button" class="calc-btn" value="4">4</button>
                    <button type="button" class="calc-btn" value="5">5</button>
                    <button type="button" class="calc-btn" value="6">6</button>
                    <button type="button" class="calc-btn operator" value="*">&times;</button>
                    <button type="button" class="calc-btn function" value="^">x^y</button>

                    <button type="button" class="calc-btn" value="1">1</button>
                    <button type="button" class="calc-btn" value="2">2</button>
                    <button type="button" class="calc-btn" value="3">3</button>
                    <button type="button" class="calc-btn operator" value="-">-</button>
                    <button type="button" class="calc-btn function" value="log">log</button>
                    
                    <button type="button" class="calc-btn" value="0">0</button>
                    <button type="button" class="calc-btn" value=".">.</button>
                    <button type="button" class="calc-btn operator" value="+">+</button>
                    <button type="button" class="calc-btn equals" value="=">=</button>
                </div>
            </div>
        </div>
    </div>

    <h1>Jaira Kaira Swimmers</h1>

    <div class="container-controls">
      <button class="control-btn add">+</button>
      <button class="control-btn remove">-</button>
    </div>

    <div id="zones"></div>

    <div id="confirm-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <p id="confirm-message"></p>
            <div class="modal-buttons">
                <button id="confirm-yes-btn">Yes</button>
                <button id="confirm-no-btn">No</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
      // --- FIREBASE V9 MODULAR SDK IMPORTS ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

      // Wrap all logic in a DOMContentLoaded event listener
      document.addEventListener('DOMContentLoaded', () => {
        
        let app, database;
        let isSaving = false; // Flag to prevent re-render for the user making the change

        try {
            // --- FIREBASE SETUP (NEW PROJECT) ---
            const firebaseConfig = {
                apiKey: "AIzaSyCiL87s1Bs9MlXRdDMdJbjwegQwAuGOcMw",
                authDomain: "jairakaira-cecb2.firebaseapp.com",
                projectId: "jairakaira-cecb2",
                storageBucket: "jairakaira-cecb2.firebasestorage.app",
                messagingSenderId: "873717861801",
                appId: "1:873717861801:web:a0f1108fbbe6a286a388b8",
                databaseURL: "https://jairakaira-cecb2-default-rtdb.firebaseio.com/"
            };
            
            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            console.log("Firebase initialized successfully with new project.");

        } catch (error) {
            console.error("CRITICAL: Firebase initialization failed.", error);
            const zonesRootError = document.getElementById('zones');
            zonesRootError.innerHTML = `<p style="color: red; text-align: center;">Error: Could not connect to the database. Please check the console for details.</p>`;
            return;
        }
    
        // --- DOM ELEMENTS ---
        const zonesRoot = document.getElementById('zones');
        const addContainerBtn = document.querySelector('.control-btn.add');
        const removeContainerBtn = document.querySelector('.control-btn.remove');
    
        // --- STOPWATCH LOGIC ---
        const stopwatch = document.querySelector('.stopwatch');
        const stopwatchToggleBtn = document.querySelector('.stopwatch-toggle-btn');
        const timeDisplay = document.getElementById('time-display');
        const startPauseBtn = document.getElementById('start-pause-btn');
        const resetBtn = document.getElementById('reset-btn');

        let startTime;
        let updatedTime;
        let difference;
        let tInterval;
        let savedTime = 0;
        let running = false;

        stopwatchToggleBtn.addEventListener('click', () => {
            stopwatch.style.display = stopwatch.style.display === 'block' ? 'none' : 'block';
        });

        function startPauseTimer() {
            if (!running) {
                startTime = new Date().getTime();
                tInterval = setInterval(getShowTime, 10);
                running = true;
                startPauseBtn.innerHTML = "Pause";
                startPauseBtn.classList.add("running");
            } else {
                clearInterval(tInterval);
                savedTime = difference;
                running = false;
                startPauseBtn.innerHTML = "Start";
                startPauseBtn.classList.remove("running");
            }
        }

        function resetTimer() {
            clearInterval(tInterval);
            savedTime = 0;
            difference = 0;
            running = false;
            timeDisplay.innerHTML = "00:00.00";
            startPauseBtn.innerHTML = "Start";
            startPauseBtn.classList.remove("running");
        }

        function getShowTime() {
            updatedTime = new Date().getTime();
            if (savedTime) {
                difference = (updatedTime - startTime) + savedTime;
            } else {
                difference = updatedTime - startTime;
            }

            let minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
            let seconds = (difference % (1000 * 60)) / 1000;

            minutes = (minutes < 10) ? "0" + minutes : minutes;
            let secondsString = seconds.toFixed(2);
            secondsString = (seconds < 10) ? "0" + secondsString : secondsString;

            timeDisplay.innerHTML = minutes + ':' + secondsString;
        }

        startPauseBtn.addEventListener('click', startPauseTimer);
        resetBtn.addEventListener('click', resetTimer);

        // --- CALCULATOR LOGIC ---
        const calculator = document.querySelector('.calculator');
        const calculatorScreen = document.querySelector('.calculator-screen');
        const calculatorKeys = document.querySelector('.calculator-keys');
        const calcToggleBtn = document.querySelector('.calc-toggle-btn');

        calcToggleBtn.addEventListener('click', () => {
            calculator.style.display = calculator.style.display === 'block' ? 'none' : 'block';
        });

        calculatorKeys.addEventListener('click', e => {
            if (!e.target.matches('button')) return;

            const key = e.target;
            const action = key.value;
            const displayedNum = calculatorScreen.value;

            if (!isNaN(action) || action === '.') {
                calculatorScreen.value = displayedNum === '0' ? action : displayedNum + action;
            } else if (['+', '-', '*', '/'].includes(action)) {
                calculatorScreen.value = displayedNum + ' ' + action + ' ';
            } else if (action === 'sin' || action === 'cos' || action === 'tan' || action === 'log' || action === 'sqrt') {
                try {
                    let result;
                    const num = parseFloat(displayedNum);
                    if (isNaN(num)) return;
                    switch(action) {
                        case 'sin': result = Math.sin(num * Math.PI / 180); break; // Degrees to radians
                        case 'cos': result = Math.cos(num * Math.PI / 180); break; // Degrees to radians
                        case 'tan': result = Math.tan(num * Math.PI / 180); break; // Degrees to radians
                        case 'log': result = Math.log10(num); break;
                        case 'sqrt': result = Math.sqrt(num); break;
                    }
                    calculatorScreen.value = result.toFixed(8);
                } catch {
                    calculatorScreen.value = 'Error';
                }
            } else if (action === '^') {
                calculatorScreen.value += '**';
            } else if (action === 'AC') {
                calculatorScreen.value = '';
            } else if (action === 'DEL') {
                calculatorScreen.value = displayedNum.slice(0, -1);
            } else if (action === '=') {
                try {
                    let expression = displayedNum.replace(/\^/g, '**');
                    calculatorScreen.value = eval(expression);
                } catch {
                    calculatorScreen.value = 'Error';
                }
            }
        });

        // --- CUSTOM CONFIRMATION MODAL ---
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        function showConfirm(message) {
            return new Promise(resolve => {
                confirmMessage.textContent = message;
                confirmModal.style.display = 'flex';

                const yesListener = () => {
                    confirmModal.style.display = 'none';
                    confirmYesBtn.removeEventListener('click', yesListener);
                    confirmNoBtn.removeEventListener('click', noListener);
                    resolve(true);
                };

                const noListener = () => {
                    confirmModal.style.display = 'none';
                    confirmYesBtn.removeEventListener('click', yesListener);
                    confirmNoBtn.removeEventListener('click', noListener);
                    resolve(false);
                };

                confirmYesBtn.addEventListener('click', yesListener);
                confirmNoBtn.addEventListener('click', noListener);
            });
        }

        // --- UTILITY FUNCTIONS ---
        function debounce(func, delay) {
          let timeout;
          return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
          };
        }
        const debouncedSave = debounce(saveStateToFirebase, 800);
    
        // --- FIREBASE DATA HANDLING (V9 SYNTAX) ---
        function saveStateToFirebase() {
          isSaving = true; // Set flag before saving
          const state = getCurrentStateFromDOM();
          const dataRef = ref(database, 'appData');
          set(dataRef, state)
            .then(() => console.log("State saved successfully!"))
            .catch(err => console.error("Error saving state: ", err))
            .finally(() => {
                // Reset the flag shortly after saving
                setTimeout(() => { isSaving = false; }, 100);
            });
        }
    
        function listenForRealtimeUpdates() {
          const dataRef = ref(database, 'appData');
          onValue(dataRef, (snapshot) => {
            if (isSaving) {
                return;
            }

            if (snapshot.exists()) {
              const state = snapshot.val();
              console.log("Real-time update received. Rendering new state.");
              renderState(state);
            } else {
              console.log("No data in database. Rendering initial containers.");
              renderInitialContainers(3);
            }
          }, (error) => {
              console.error("Error listening for real-time updates:", error);
          });
        }
        
        // --- INITIAL DATA LOAD ---
        function initialLoad() {
            const dataRef = ref(database, 'appData');
            get(dataRef).then((snapshot) => {
                if (snapshot.exists()) {
                    renderState(snapshot.val());
                } else {
                    renderInitialContainers(3);
                }
                listenForRealtimeUpdates();
            }).catch(err => {
                console.error("Initial data load failed:", err);
                renderInitialContainers(3);
                listenForRealtimeUpdates();
            });
        }
    
        // --- STATE SCRAPING & RENDERING ---
        function getCurrentStateFromDOM() {
          const containers = [...zonesRoot.querySelectorAll('.zone')].map(zoneEl => {
            const containerTitle = zoneEl.querySelector('.zone-header > span:last-child').textContent;
            const dropdowns = [...zoneEl.querySelectorAll('.section')].map(sectionEl => {
              const dropdownTitle = sectionEl.querySelector('.header > span:last-child').textContent;
              const jairaTableEl = sectionEl.querySelector('.table-top');
              const kairaTableEl = sectionEl.querySelector('.table-bottom');
    
              const getTableData = (tableEl) => {
                if (!tableEl) return { dataRows: [], dateRow: [], noteContent: '', isNoteVisible: false };
                const dataRows = [...tableEl.querySelectorAll('tr:not(.date-row)')].map(tr => 
                  [...tr.cells].map(td => td.textContent)
                );
                const dateRowCells = tableEl.querySelector('.date-row')?.cells || [];
                const dateRow = [...dateRowCells].map(td => td.textContent);
                
                // NEW: Scrape note data
                const noteArea = tableEl.closest('.content').querySelector('.note-area');
                const noteContent = noteArea ? noteArea.value : '';
                const isNoteVisible = noteArea ? noteArea.parentElement.style.display === 'block' : false;

                return { dataRows, dateRow, noteContent, isNoteVisible };
              };
    
              return {
                title: dropdownTitle,
                isOpen: sectionEl.hasAttribute('open'),
                jairaTable: getTableData(jairaTableEl),
                kairaTable: getTableData(kairaTableEl),
              };
            });
            return {
              title: containerTitle,
              isOpen: zoneEl.hasAttribute('open'),
              dropdowns
            };
          });
          return { containers };
        }
    
        function renderState(state) {
          const activeElement = document.activeElement;
          const activeId = activeElement.id;

          zonesRoot.innerHTML = '';
          if (state && state.containers && state.containers.length > 0) {
              state.containers.forEach((containerData, cIndex) => {
                  const zone = createZone(cIndex + 1, containerData.title, containerData.isOpen);
                  zonesRoot.appendChild(zone);
                  const content = zone.querySelector('.zone-content');
                  containerData.dropdowns?.forEach((dropdownData, dIndex) => {
                    addOneDropdown(content, dropdownData, cIndex, dIndex);
                  });
              });
              window.containerCount = state.containers.length;
          } else {
              renderInitialContainers(3);
          }

          if (activeId) {
              const newActiveElement = document.getElementById(activeId);
              if (newActiveElement) {
                  newActiveElement.focus();
              }
          }
        }
        
        function renderInitialContainers(count) {
          zonesRoot.innerHTML = '';
          window.containerCount = count;
          for (let i = 1; i <= count; i++) {
            zonesRoot.appendChild(createZone(i));
          }
          saveStateToFirebase();
        }
    
        // --- EVENT LISTENERS ---
        addContainerBtn.addEventListener('click', () => {
          window.containerCount = (window.containerCount || 0) + 1;
          zonesRoot.appendChild(createZone(window.containerCount));
          debouncedSave();
        });
    
        removeContainerBtn.addEventListener('click', async () => {
          if (zonesRoot.lastElementChild) {
            const confirmed = await showConfirm("Are you sure you want to remove the last container?");
            if (confirmed) {
                zonesRoot.removeChild(zonesRoot.lastElementChild);
                window.containerCount = Math.max(0, (window.containerCount || 0) - 1);
                debouncedSave();
            }
          }
        });
    
        // --- CREATION FUNCTIONS ---
        function createZone(index, titleText, isOpen = false) {
          if (!titleText) {
              titleText = `Container #${index}`;
          }
          const zone = document.createElement('div');
          zone.className = 'zone';
          if (isOpen) {
              zone.setAttribute('open', '');
          }
    
          const header = document.createElement('div');
          header.className = 'zone-header';
          const plus = document.createElement('span');
          plus.className = 'plus';
          plus.textContent = isOpen ? '-' : '+';
          const title = document.createElement('span');
          title.textContent = titleText;
          makeCaptionEditable(title, 'container');
    
          header.appendChild(plus);
          header.appendChild(title);
    
          const content = document.createElement('div');
          content.className = 'zone-content';
          const ddControls = document.createElement('div');
          ddControls.className = 'dropdown-controls';
    
          const addDropdownBtn = document.createElement('button');
          addDropdownBtn.className = 'add-btn';
          addDropdownBtn.textContent = '+';
          addDropdownBtn.addEventListener('click', () => addOneDropdown(content, null, index - 1, (zone.querySelectorAll('.section').length)));
    
          const removeDropdownBtn = document.createElement('button');
          removeDropdownBtn.className = 'add-btn';
          removeDropdownBtn.style.background = '#ef9a9a';
          removeDropdownBtn.textContent = '-';
          removeDropdownBtn.addEventListener('click', () => removeOneDropdown(content));
          
          ddControls.appendChild(addDropdownBtn);
          ddControls.appendChild(removeDropdownBtn);
    
          const body = document.createElement('div');
          body.className = 'zone-body';
          content.appendChild(ddControls);
          content.appendChild(body);
    
          header.addEventListener('click', (e) => {
            if (e.target.isContentEditable) return;
            zone.toggleAttribute('open');
            plus.textContent = zone.hasAttribute('open') ? '-' : '+';
            debouncedSave(); // Save state on toggle
          });
    
          zone.appendChild(header);
          zone.appendChild(content);
          return zone;
        }
    
        async function addOneDropdown(containerEl, data = null, cIndex, dIndex) {
          const body = containerEl.querySelector('.zone-body');
          const idx = body.children.length + 1;
          const section = createSection(data ? data.title : `Dropdown ${idx}`, data, cIndex, dIndex);
          body.appendChild(section);
          if (!data) debouncedSave();
        }
    
        async function removeOneDropdown(containerEl) {
          const body = containerEl.querySelector('.zone-body');
          if (!body.lastElementChild) return;
          const confirmed = await showConfirm("Are you sure you want to remove the last dropdown?");
          if (confirmed) {
              body.removeChild(body.lastElementChild);
              debouncedSave();
          }
        }
    
        function createSection(caption, data = null, cIndex, dIndex) {
          const section = document.createElement('div');
          section.className = 'section';
          if (data && data.isOpen) {
              section.setAttribute('open', '');
          }

          const header = document.createElement('button');
          header.className = 'header';
          header.setAttribute('aria-expanded', data?.isOpen || 'false');

          const plus = document.createElement('span');
          plus.className = 'plus';
          plus.textContent = (data && data.isOpen) ? '-' : '+';
          const title = document.createElement('span');
          title.textContent = caption;
          makeCaptionEditable(title, 'dropdown');
          header.appendChild(plus);
          header.appendChild(title);
    
          const content = document.createElement('div');
          content.className = 'content';
    
          const jairaData = data?.jairaTable || { dataRows: [['']], dateRow: [], noteContent: '' };
          const kairaData = data?.kairaTable || { dataRows: [['']], dateRow: [], noteContent: '' };
          
          const topTitle = document.createElement('div');
          topTitle.className = 'table-title';
          topTitle.textContent = 'Jaira';
          const top = buildEditableTable(jairaData, 'table-top');
          
          const bottomTitle = document.createElement('div');
          bottomTitle.className = 'table-title';
          bottomTitle.textContent = 'Kaira';
          const bottom = buildEditableTable(kairaData, 'table-bottom');
    
          // NEW: Add note areas and populate them with saved data
          const topNoteWrap = document.createElement('div');
          topNoteWrap.className = 'note-wrap';
          const topNoteArea = document.createElement('textarea');
          topNoteArea.className = 'note-area';
          topNoteArea.placeholder = 'Type Jaira notes here...';
          topNoteArea.value = jairaData.noteContent || '';
          topNoteWrap.style.display = jairaData.isNoteVisible ? 'block' : 'none';
          topNoteArea.addEventListener('keyup', debouncedSave);
          topNoteArea.addEventListener('blur', debouncedSave);
          topNoteWrap.appendChild(topNoteArea);
          
          const bottomNoteWrap = document.createElement('div');
          bottomNoteWrap.className = 'note-wrap';
          const bottomNoteArea = document.createElement('textarea');
          bottomNoteArea.className = 'note-area';
          bottomNoteArea.placeholder = 'Type Kaira notes here...';
          bottomNoteArea.value = kairaData.noteContent || '';
          bottomNoteWrap.style.display = kairaData.isNoteVisible ? 'block' : 'none';
          bottomNoteArea.addEventListener('keyup', debouncedSave);
          bottomNoteArea.addEventListener('blur', debouncedSave);
          bottomNoteWrap.appendChild(bottomNoteArea);

          content.appendChild(topTitle);
          content.appendChild(top.toolbar);
          content.appendChild(top.container);
          content.appendChild(top.graphWrap);
          content.appendChild(topNoteWrap);
          content.appendChild(document.createElement('hr'));
          content.appendChild(bottomTitle);
          content.appendChild(bottom.toolbar);
          content.appendChild(bottom.container);
          content.appendChild(bottom.graphWrap);
          content.appendChild(bottomNoteWrap);
    
          header.addEventListener('click', (e) => {
            if (e.target.isContentEditable) return;
            section.toggleAttribute('open');
            header.setAttribute('aria-expanded', section.hasAttribute('open'));
            plus.textContent = section.hasAttribute('open') ? '-' : '+';
            debouncedSave(); // Save state on toggle
          });
          section.appendChild(header);
          section.appendChild(content);
          return section;
        }
    
        function buildEditableTable(tableData, extraClass) {
          const container = document.createElement('div');
          container.className = 'table-container';
          const table = document.createElement('table');
          if (extraClass) table.classList.add(extraClass);
          
          const rows = (tableData && tableData.dataRows && tableData.dataRows.length > 0) ? tableData.dataRows : [['']];
          
          rows.forEach(rowData => {
            const tr = document.createElement('tr');
            const cells = (rowData && rowData.length > 0) ? rowData : [''];
            cells.forEach(cellData => {
              const td = document.createElement('td');
              td.contentEditable = "true";
              td.textContent = cellData;
              td.addEventListener('blur', debouncedSave);
              td.addEventListener('keyup', debouncedSave);
              tr.appendChild(td);
            });
            table.appendChild(tr);
          });
    
          createOrRefreshDateRow(table, tableData ? tableData.dateRow : []);
          
          const toolbar = document.createElement('div');
          toolbar.className = 'table-toolbar';
    
          const addColBtn = document.createElement('button');
          addColBtn.className = 'mini-btn add-col';
          addColBtn.textContent = '+ Column';
          addColBtn.addEventListener('click', () => { addColumn(table); createOrRefreshDateRow(table); debouncedSave(); });
    
          const addRowBtn = document.createElement('button');
          addRowBtn.className = 'mini-btn add-row';
          addRowBtn.textContent = '+ Row';
          addRowBtn.addEventListener('click', () => { addRow(table); debouncedSave(); });
    
          const delColBtn = document.createElement('button');
          delColBtn.className = 'mini-btn del-col';
          delColBtn.textContent = '- Column';
          delColBtn.addEventListener('click', async () => {
            const confirmed = await showConfirm("Delete last column?");
            if (confirmed) {
                removeColumn(table); 
                createOrRefreshDateRow(table); 
                debouncedSave();
            }
          });
    
          const delRowBtn = document.createElement('button');
          delRowBtn.className = 'mini-btn del-row';
          delRowBtn.textContent = '- Row';
          delRowBtn.addEventListener('click', async () => {
            const confirmed = await showConfirm("Delete last row?");
            if (confirmed) {
                removeRow(table); 
                debouncedSave();
            }
          });
    
          const graphBtn = document.createElement('button');
          graphBtn.className = 'graph-btn';
          graphBtn.textContent = 'ðŸ“ˆ Graph';
          const graphWrap = document.createElement('div');
          graphWrap.className = 'graph-wrap';
          const canvas = document.createElement('canvas');
          graphWrap.appendChild(canvas);

          // NEW: Create and configure Note button
          const noteBtn = document.createElement('button');
          noteBtn.className = 'graph-btn note-btn';
          noteBtn.textContent = 'ðŸ“ Note';
          noteBtn.addEventListener('click', () => {
              const noteWrap = table.closest('.content').querySelector('.note-wrap');
              if (noteWrap) {
                  noteWrap.style.display = noteWrap.style.display === 'block' ? 'none' : 'block';
                  debouncedSave(); // Save visibility state change
              }
          });
    
          toolbar.appendChild(addColBtn);
          toolbar.appendChild(addRowBtn);
          toolbar.appendChild(delColBtn);
          toolbar.appendChild(delRowBtn);
          toolbar.appendChild(graphBtn);
          toolbar.appendChild(noteBtn); // Add note button to toolbar
          graphBtn.addEventListener('click', () => toggleGraph(table, canvas, graphWrap));
          container.appendChild(table);
          updateTableScroll(table);
          return { container, table, toolbar, graphWrap };
        }
        
        function getTBody(table){
          return table.tBodies && table.tBodies.length > 0 ? table.tBodies[0] : table;
        }
    
        function stampNow(e) {
          const d = new Date();
          const mm = String(d.getMonth() + 1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          const yy = String(d.getFullYear()).slice(2);
          e.target.textContent = `${mm}/${dd}/${yy}`;
          debouncedSave();
        }
    
        function getDateRow(table) {
          return table.querySelector('.date-row');
        }
    
        function getColumnCount(table) {
          const firstNormalRow = table.querySelector('tr:not(.date-row)');
          return firstNormalRow ? firstNormalRow.cells.length : (getDateRow(table) ? getDateRow(table).cells.length : 1);
        }
        
        function createOrRefreshDateRow(table, dateData = []) {
          const cols = getColumnCount(table);
          let dateRow = getDateRow(table);
          if (!dateRow) {
            dateRow = getTBody(table).insertRow();
            dateRow.classList.add('date-row');
          }
          
          while (dateRow.cells.length < cols) {
              const td = dateRow.insertCell();
              td.contentEditable = "false";
              td.addEventListener('click', stampNow);
          }
          while (dateRow.cells.length > cols) {
              dateRow.deleteCell(-1);
          }

          if(dateData && dateData.length > 0) {
              [...dateRow.cells].forEach((td, i) => {
                  td.textContent = dateData[i] || '';
              });
          }
        }
    
        function updateTableScroll(table) {
          table.classList.toggle('wide', getColumnCount(table) > 10);
        }
    
        function addColumn(table) {
          [...table.rows].forEach(tr => {
            const td = tr.insertCell(-1);
            if (tr.classList.contains('date-row')) {
              td.contentEditable = "false";
              td.addEventListener('click', stampNow);
            } else {
              td.contentEditable = "true";
              td.addEventListener('blur', debouncedSave);
              td.addEventListener('keyup', debouncedSave);
            }
          });
          updateTableScroll(table);
        }
    
        function removeColumn(table) {
          if (getColumnCount(table) <= 1) return;
          [...table.rows].forEach(tr => tr.deleteCell(-1));
          updateTableScroll(table);
        }
    
        function addRow(table) {
          const cols = getColumnCount(table);
          const dateRow = getDateRow(table);
          const newRow = getTBody(table).insertRow(dateRow ? dateRow.rowIndex : -1);
          for (let i = 0; i < cols; i++) {
            const td = newRow.insertCell();
            td.contentEditable = "true";
            td.addEventListener('blur', debouncedSave);
            td.addEventListener('keyup', debouncedSave);
          }
        }
    
        function removeRow(table) {
          const normalRows = [...table.querySelectorAll('tr:not(.date-row)')];
          if (normalRows.length <= 1) return;
          normalRows[normalRows.length - 1].remove();
        }
    
        function toggleGraph(table, canvas, graphWrap) {
          if (graphWrap.style.display === 'block') {
            graphWrap.style.display = 'none';
            return;
          }
          graphWrap.style.display = 'block';
          const normalRows = [...table.rows].filter(r => !r.classList.contains('date-row'));
          if (!normalRows.length) return;
          const colCount = normalRows[0].cells.length;
          let lastNonEmptyCol = -1;
          for (let c = colCount - 1; c >= 0; c--) {
              for (let r = 0; r < normalRows.length; r++) {
                  if (normalRows[r].cells[c] && !isNaN(parseFloat(normalRows[r].cells[c].textContent))) {
                      lastNonEmptyCol = c;
                      break;
                  }
              }
              if(lastNonEmptyCol !== -1) break;
          }

          if (lastNonEmptyCol === -1) return;

          const validCols = [];
          const labels = [];
          for (let c = 0; c <= lastNonEmptyCol; c++) {
            let hasNumber = false;
            for (let r = 0; r < normalRows.length; r++) {
              if (normalRows[r].cells[c] && !isNaN(parseFloat(normalRows[r].cells[c].textContent))) { hasNumber = true; break; }
            }
            if (hasNumber) {
                validCols.push(c);
                labels.push(`Col ${c + 1}`);
            }
          }

          if (!validCols.length) return;

          const datasets = [];
          const allRowData = [];

          normalRows.forEach((row, rIdx) => {
            const dataPoints = validCols.map(c => {
              const cell = row.cells[c];
              if (!cell) return null;
              const v = parseFloat(cell.textContent);
              return isNaN(v) ? null : v;
            });
            allRowData.push(dataPoints);

            let firstValIndex = dataPoints.findIndex(p => p !== null);
            let lastValIndex = dataPoints.map(p => p !== null).lastIndexOf(true);

            if(firstValIndex === -1) return;

            const finalData = dataPoints.map((p, i) => (i >= firstValIndex && i <= lastValIndex) ? p : null);
            
            datasets.push({
              label: `Row ${rIdx + 1}`, data: finalData,
              borderColor: `hsla(${(rIdx * 60) % 360}, 70%, 50%, 0.4)`, // Lighter color
              backgroundColor: `hsla(${(rIdx * 60) % 360}, 70%, 50%, 0.1)`,
              borderWidth: 1, // Thinner line
              fill: false, spanGaps: false, tension: 0.2,
            });
          });

          // Calculate and add average line
          const averageData = [];
          for (let i = 0; i < labels.length; i++) {
              let sum = 0;
              let count = 0;
              allRowData.forEach(rowData => {
                  if (rowData[i] !== null) {
                      sum += rowData[i];
                      count++;
                  }
              });
              averageData.push(count > 0 ? sum / count : null);
          }

          datasets.push({
              label: 'Average',
              data: averageData,
              borderColor: 'rgba(54, 162, 235, 1)', // Dark Blue
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              borderWidth: 3, // Thicker line
              fill: false,
              tension: 0.2,
              pointRadius: 4,
              pointHoverRadius: 6
          });

          if (canvas._chart) canvas._chart.destroy();
          canvas._chart = new Chart(canvas.getContext('2d'), {
            type: 'line', data: { labels, datasets },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
          });
        }
    
        function makeCaptionEditable(spanEl, type) { // type = 'container' or 'dropdown'
            let pressTimer = null;
            const holdDuration = 600; // ms

            const startPress = (e) => {
                if (spanEl.isContentEditable) return;
                e.stopPropagation(); // Prevent header click from firing
                pressTimer = setTimeout(() => {
                    enableEdit(spanEl, type);
                }, holdDuration);
            };

            const cancelPress = () => {
                clearTimeout(pressTimer);
            };

            spanEl.style.cursor = 'text';
            spanEl.setAttribute('tabindex', '0');

            // Mouse events
            spanEl.addEventListener('mousedown', startPress);
            spanEl.addEventListener('mouseup', cancelPress);
            spanEl.addEventListener('mouseleave', cancelPress);

            // Touch events for mobile
            spanEl.addEventListener('touchstart', startPress);
            spanEl.addEventListener('touchend', cancelPress);
            spanEl.addEventListener('touchmove', cancelPress);

            // Keep F2 for accessibility
            spanEl.addEventListener('keydown', (e) => {
                if (e.key === 'F2' && !spanEl.isContentEditable) {
                    e.preventDefault();
                    enableEdit(spanEl, type);
                }
            });

            function enableEdit(el, editType) {
                clearTimeout(pressTimer);

                const editClass = editType === 'container' ? 'editing-container' : 'editing-dropdown';
                
                el.contentEditable = 'true';
                el.classList.add(editClass);
                el.focus();
                window.getSelection().selectAllChildren(el);

                function commit() {
                    el.contentEditable = 'false';
                    el.classList.remove(editClass);
                    cleanup();
                    debouncedSave();
                }
                function onKey(e) { if (e.key === 'Enter' || e.key === 'Escape') { e.preventDefault(); commit(); } }
                function onBlur() { commit(); }
                function cleanup() {
                    el.removeEventListener('keydown', onKey);
                    el.removeEventListener('blur', onBlur);
                }
                el.addEventListener('keydown', onKey);
                el.addEventListener('blur', onBlur);
            }
        }
    
        // --- INITIALIZE APP ---
        initialLoad();
    
      });
      
    </script>

</body>
</html>
