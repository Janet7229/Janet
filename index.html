<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dynamic Containers with Firebase</title>
    <style>
      body{
        font-family:"Calibri","Helvetica Neue",Arial,sans-serif;
        max-width:900px;margin:2rem auto;background:#fff8f0;color:#333;
      }
      h1{
        text-align:center;font-size:2rem;margin-bottom:1rem;color:#ff6f61;
      }
      .container-controls{
        display:flex;justify-content:center;gap:10px;margin-bottom:15px;
      }
      .control-btn{
        padding:6px 12px;border:none;border-radius:6px;font-size:18px;color:#fff;
        cursor:pointer;transition:.2s;width:40px;height:40px;text-align:center;
      }
      .control-btn.add{background:#a5d6a7;}
      .control-btn.remove{background:#ef9a9a;}
      .control-btn:hover{transform:scale(1.05);}
      .zone{
        border:2px solid #ffb347;border-radius:10px;margin-bottom:15px;overflow:hidden;
        box-shadow:0 2px 6px rgba(0,0,0,.1);background:#fff4e6;
      }
      .zone-header{
        display:flex;align-items:center;gap:8px;padding:12px 14px;background:#ffe0b2;
        cursor:pointer;font-weight:bold;font-size:1.1rem;
      }
      .zone .plus{
        width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;
        border:1px solid #ff9800;border-radius:4px;font-weight:bold;background:#ffcc80;color:#333;
        transition:transform .15s;
      }
      .zone[open] .zone-header .plus{transform:rotate(45deg);}
      .zone-content{display:none;padding:12px 14px 16px;background:#fffef8;}
      .zone[open] .zone-content{display:block;}
      .mini-btn,.add-btn,.graph-btn{
        padding:6px 10px;font-size:13px;cursor:pointer;border:none;border-radius:6px;
        transition:transform .1s,background .2s;color:#fff;
      }
      .add-btn{background:#f48fb1;width:40px;height:40px;font-size:18px;}
      .mini-btn.add-col{background:#80cbc4;} /* + Column */
      .mini-btn.add-row{background:#90caf9;} /* + Row */
      .mini-btn.del-col{background:#f48fb1;} /* - Column */
      .mini-btn.del-row{background:#ffcc80;} /* - Row */
      .graph-btn{background:#b39ddb;width:auto;height:auto;padding:6px 10px;font-size:13px;}
      .mini-btn:hover,.add-btn:hover,.graph-btn:hover{transform:scale(1.05);}
      .dropdown-controls,.table-toolbar{
        display:flex;gap:.5rem;margin:8px 0;flex-wrap:wrap;
      }
      .section{
        border:1px solid #ddd;border-radius:6px;margin-bottom:10px;overflow:hidden;
      }
      .header{
        display:flex;align-items:center;gap:8px;padding:12px 14px;background:#ffe0b2;
        cursor:pointer;border:none;font-weight:bold;width:100%;
      }
      .header .plus{
        width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;
        border:1px solid #ff9800;border-radius:4px;background:#ffcc80;font-weight:bold;
      }
      .content{padding:10px 14px 14px;display:none;}
      .section[open] .content{display:block;}
      .table-title{
        font-size:1rem;font-weight:bold;margin:8px 0 4px;text-align:center;color:#4a148c;
      }
      .table-container{
        overflow-x:auto;border:2px solid #ccc;border-radius:5px;margin-top:5px;
      }
      table{
        border-collapse:collapse;width:100%;
      }
      table.wide{min-width:1000px;}
      table,th,td{border:3px solid #000;}
      th,td{padding:6px;text-align:center;font-size:14px;}
      td[contenteditable="true"]{cursor:text;}
      .table-top td,.table-top th{background:#ffd6e7;}
      .table-bottom td,.table-bottom th{background:#e6d6ff;}
      .date-row td{
        background:#ffcccc!important;cursor:pointer;
        -webkit-user-select:none; /* Safari compatibility */
        user-select:none;
        font-size:7px;
      }
      .graph-wrap{
        margin-top:8px;padding:8px;background:#fff;border:2px dashed #b39ddb;border-radius:8px;
        display:none;
      }
      .editing{
        outline:2px dashed #ff6f61;background:#fff5ee;
      }
    </style>
</head>
<body>

    <h1>Jaira Kaira Swimmers</h1>

    <div class="container-controls">
      <button class="control-btn add">+</button>
      <button class="control-btn remove">-</button>
    </div>

    <div id="zones"></div>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Main App Script with Modern Firebase SDK -->
    <script type="module">
      // --- FIREBASE V9 MODULAR SDK IMPORTS ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

      // Wrap all logic in a DOMContentLoaded event listener
      document.addEventListener('DOMContentLoaded', () => {
        
        let app, database;

        try {
            // --- FIREBASE SETUP ---
            const firebaseConfig = {
                apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
                authDomain: "shamankingdata.firebaseapp.com",
                projectId: "shamankingdata",
                storageBucket: "shamankingdata.firebasestorage.app",
                messagingSenderId: "757444066890",
                appId: "1:757444066890:web:e4f9d41e2905e588d930b3",
                databaseURL: "https://shamankingdata-default-rtdb.firebaseio.com/"
            };
            
            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            console.log("Firebase initialized successfully.");

        } catch (error) {
            console.error("CRITICAL: Firebase initialization failed.", error);
            // If Firebase fails to init, we can't proceed.
            // You could show a user-friendly error message on the page here.
            const zonesRootError = document.getElementById('zones');
            zonesRootError.innerHTML = `<p style="color: red; text-align: center;">Error: Could not connect to the database. Please check the console for details.</p>`;
            return; // Stop execution if Firebase fails
        }
    
        // --- DOM ELEMENTS ---
        const zonesRoot = document.getElementById('zones');
        const addContainerBtn = document.querySelector('.control-btn.add');
        const removeContainerBtn = document.querySelector('.control-btn.remove');
      
        // --- UTILITY FUNCTIONS ---
        function debounce(func, delay) {
          let timeout;
          return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
          };
        }
        const debouncedSave = debounce(saveStateToFirebase, 800);
      
        // --- FIREBASE DATA HANDLING (V9 SYNTAX) ---
        function saveStateToFirebase() {
          const state = getCurrentStateFromDOM();
          const dataRef = ref(database, 'appData');
          set(dataRef, state)
            .then(() => console.log("State saved successfully!"))
            .catch(err => console.error("Error saving state: ", err));
        }
      
        function loadStateFromFirebase() {
          const dataRef = ref(database, 'appData');
          get(dataRef).then((snapshot) => {
            if (snapshot.exists()) {
              const state = snapshot.val();
              console.log("State loaded successfully!");
              renderState(state);
            } else {
              console.log("No data found. Rendering initial containers.");
              renderInitialContainers(3);
            }
          }).catch((err) => {
              console.error("Error loading data from Firebase:", err);
              renderInitialContainers(3); // Fallback
          });
        }
      
        // --- STATE SCRAPING & RENDERING ---
        function getCurrentStateFromDOM() {
          const containers = [...zonesRoot.querySelectorAll('.zone')].map(zoneEl => {
            const containerTitle = zoneEl.querySelector('.zone-header > span:last-child').textContent;
            const dropdowns = [...zoneEl.querySelectorAll('.section')].map(sectionEl => {
              const dropdownTitle = sectionEl.querySelector('.header > span:last-child').textContent;
              const jairaTableEl = sectionEl.querySelector('.table-top');
              const kairaTableEl = sectionEl.querySelector('.table-bottom');
      
              const getTableData = (tableEl) => {
                if (!tableEl) return { dataRows: [], dateRow: [] };
                const dataRows = [...tableEl.querySelectorAll('tr:not(.date-row)')].map(tr => 
                  [...tr.cells].map(td => td.textContent)
                );
                const dateRowCells = tableEl.querySelector('.date-row')?.cells || [];
                const dateRow = [...dateRowCells].map(td => td.textContent);
                return { dataRows, dateRow };
              };
      
              return {
                title: dropdownTitle,
                jairaTable: getTableData(jairaTableEl),
                kairaTable: getTableData(kairaTableEl),
              };
            });
            return { title: containerTitle, dropdowns };
          });
          return { containers };
        }
      
        function renderState(state) {
          zonesRoot.innerHTML = '';
          if (state && state.containers && state.containers.length > 0) {
              state.containers.forEach(containerData => {
                const zone = createZone(null, containerData.title);
                zonesRoot.appendChild(zone);
                const content = zone.querySelector('.zone-content');
                containerData.dropdowns?.forEach(dropdownData => {
                  addOneDropdown(content, dropdownData);
                });
              });
              window.containerCount = state.containers.length;
          } else {
              renderInitialContainers(3);
          }
        }
        
        function renderInitialContainers(count) {
          zonesRoot.innerHTML = '';
          window.containerCount = count;
          for (let i = 1; i <= count; i++) {
            zonesRoot.appendChild(createZone(i));
          }
          saveStateToFirebase();
        }
      
        // --- EVENT LISTENERS ---
        addContainerBtn.addEventListener('click', () => {
          window.containerCount = (window.containerCount || 0) + 1;
          zonesRoot.appendChild(createZone(window.containerCount));
          debouncedSave();
        });
      
        removeContainerBtn.addEventListener('click', () => {
          if (zonesRoot.lastElementChild) {
            if (confirm("Are you sure you want to remove the last container?")) {
              zonesRoot.removeChild(zonesRoot.lastElementChild);
              window.containerCount = Math.max(0, (window.containerCount || 0) - 1);
              debouncedSave();
            }
          }
        });
      
        // --- CREATION FUNCTIONS ---
        function createZone(index, titleText) {
          if (!titleText) {
              titleText = `Container #${index}`;
          }
          const zone = document.createElement('div');
          zone.className = 'zone';
      
          const header = document.createElement('div');
          header.className = 'zone-header';
          const plus = document.createElement('span');
          plus.className = 'plus';
          plus.textContent = '+';
          const title = document.createElement('span');
          title.textContent = titleText;
          makeCaptionEditable(title);
      
          header.appendChild(plus);
          header.appendChild(title);
      
          const content = document.createElement('div');
          content.className = 'zone-content';
          const ddControls = document.createElement('div');
          ddControls.className = 'dropdown-controls';
      
          const addDropdownBtn = document.createElement('button');
          addDropdownBtn.className = 'add-btn';
          addDropdownBtn.textContent = '+';
          addDropdownBtn.addEventListener('click', () => addOneDropdown(content));
      
          const removeDropdownBtn = document.createElement('button');
          removeDropdownBtn.className = 'add-btn';
          removeDropdownBtn.style.background = '#ef9a9a';
          removeDropdownBtn.textContent = '-';
          removeDropdownBtn.addEventListener('click', () => removeOneDropdown(content));
          
          ddControls.appendChild(addDropdownBtn);
          ddControls.appendChild(removeDropdownBtn);
      
          const body = document.createElement('div');
          body.className = 'zone-body';
          content.appendChild(ddControls);
          content.appendChild(body);
      
          header.addEventListener('click', (e) => {
            if (e.target.isContentEditable) return;
            zone.toggleAttribute('open');
          });
      
          zone.appendChild(header);
          zone.appendChild(content);
          return zone;
        }
      
        function addOneDropdown(containerEl, data = null) {
          const body = containerEl.querySelector('.zone-body');
          const idx = body.children.length + 1;
          const section = createSection(data ? data.title : `Dropdown ${idx}`, data);
          body.appendChild(section);
          if (!data) debouncedSave();
        }
      
        function removeOneDropdown(containerEl) {
          const body = containerEl.querySelector('.zone-body');
          if (!body.lastElementChild) return;
          if (confirm("Are you sure you want to remove the last dropdown?")) {
            body.removeChild(body.lastElementChild);
            debouncedSave();
          }
        }
      
        function createSection(caption, data = null) {
          const section = document.createElement('div');
          section.className = 'section';
          const header = document.createElement('button');
          header.className = 'header';
          const plus = document.createElement('span');
          plus.className = 'plus';
          plus.textContent = '+';
          const title = document.createElement('span');
          title.textContent = caption;
          makeCaptionEditable(title);
          header.appendChild(plus);
          header.appendChild(title);
      
          const content = document.createElement('div');
          content.className = 'content';
      
          const jairaData = data && data.jairaTable ? data.jairaTable : { dataRows: [['']], dateRow: [] };
          const kairaData = data && data.kairaTable ? data.kairaTable : { dataRows: [['']], dateRow: [] };
          
          const topTitle = document.createElement('div');
          topTitle.className = 'table-title';
          topTitle.textContent = 'Jaira';
          const top = buildEditableTable(jairaData, 'table-top');
          
          const bottomTitle = document.createElement('div');
          bottomTitle.className = 'table-title';
          bottomTitle.textContent = 'Kaira';
          const bottom = buildEditableTable(kairaData, 'table-bottom');
      
          content.appendChild(topTitle);
          content.appendChild(top.toolbar);
          content.appendChild(top.container);
          content.appendChild(top.graphWrap);
          content.appendChild(document.createElement('hr'));
          content.appendChild(bottomTitle);
          content.appendChild(bottom.toolbar);
          content.appendChild(bottom.container);
          content.appendChild(bottom.graphWrap);
      
          header.addEventListener('click', (e) => {
            if (e.target.isContentEditable) return;
            section.toggleAttribute('open');
          });
          section.appendChild(header);
          section.appendChild(content);
          return section;
        }
      
        function buildEditableTable(tableData, extraClass) {
          const container = document.createElement('div');
          container.className = 'table-container';
          const table = document.createElement('table');
          if (extraClass) table.classList.add(extraClass);
          
          const rows = (tableData && tableData.dataRows && tableData.dataRows.length > 0) ? tableData.dataRows : [['']];
          
          rows.forEach(rowData => {
            const tr = document.createElement('tr');
            const cells = (rowData && rowData.length > 0) ? rowData : [''];
            cells.forEach(cellData => {
              const td = document.createElement('td');
              td.contentEditable = "true";
              td.textContent = cellData;
              td.addEventListener('blur', debouncedSave);
              tr.appendChild(td);
            });
            table.appendChild(tr);
          });
      
          createOrRefreshDateRow(table, tableData ? tableData.dateRow : []);
          
          const toolbar = document.createElement('div');
          toolbar.className = 'table-toolbar';
      
          const addColBtn = document.createElement('button');
          addColBtn.className = 'mini-btn add-col';
          addColBtn.textContent = '+ Column';
          addColBtn.addEventListener('click', () => { addColumn(table); createOrRefreshDateRow(table); debouncedSave(); });
      
          const addRowBtn = document.createElement('button');
          addRowBtn.className = 'mini-btn add-row';
          addRowBtn.textContent = '+ Row';
          addRowBtn.addEventListener('click', () => { addRow(table); debouncedSave(); });
      
          const delColBtn = document.createElement('button');
          delColBtn.className = 'mini-btn del-col';
          delColBtn.textContent = '- Column';
          delColBtn.addEventListener('click', () => {
            if (confirm("Delete last column?")) { removeColumn(table); createOrRefreshDateRow(table); debouncedSave(); }
          });
      
          const delRowBtn = document.createElement('button');
          delRowBtn.className = 'mini-btn del-row';
          delRowBtn.textContent = '- Row';
          delRowBtn.addEventListener('click', () => {
            if (confirm("Delete last row?")) { removeRow(table); debouncedSave(); }
          });
      
          const graphBtn = document.createElement('button');
          graphBtn.className = 'graph-btn';
          graphBtn.textContent = '📈';
          const graphWrap = document.createElement('div');
          graphWrap.className = 'graph-wrap';
          const canvas = document.createElement('canvas');
          graphWrap.appendChild(canvas);
      
          toolbar.appendChild(addColBtn);
          toolbar.appendChild(addRowBtn);
          toolbar.appendChild(delColBtn);
          toolbar.appendChild(delRowBtn);
          toolbar.appendChild(graphBtn);
          graphBtn.addEventListener('click', () => toggleGraph(table, canvas, graphWrap));
          container.appendChild(table);
          updateTableScroll(table);
          return { container, table, toolbar, graphWrap };
        }
        
        function getTBody(table){
          return table.tBodies && table.tBodies.length > 0 ? table.tBodies[0] : table;
        }
      
        function stampNow(e) {
          const d = new Date();
          const mm = String(d.getMonth() + 1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          const yy = String(d.getFullYear()).slice(2);
          e.target.textContent = `${mm}/${dd}/${yy}`;
          debouncedSave();
        }
      
        function getDateRow(table) {
          return table.querySelector('.date-row');
        }
      
        function getColumnCount(table) {
          const firstNormalRow = table.querySelector('tr:not(.date-row)');
          return firstNormalRow ? firstNormalRow.cells.length : (getDateRow(table) ? getDateRow(table).cells.length : 1);
        }
        
        function createOrRefreshDateRow(table, dateData = []) {
          const cols = getColumnCount(table);
          let dateRow = getDateRow(table);
          if (!dateRow) {
            dateRow = getTBody(table).insertRow();
            dateRow.classList.add('date-row');
          }
          
          while (dateRow.cells.length < cols) {
              const td = dateRow.insertCell();
              td.contentEditable = "false";
              td.addEventListener('click', stampNow);
          }
          while (dateRow.cells.length > cols) {
              dateRow.deleteCell(-1);
          }
  
          if(dateData && dateData.length > 0) {
              [...dateRow.cells].forEach((td, i) => {
                  td.textContent = dateData[i] || '';
              });
          }
        }
      
        function updateTableScroll(table) {
          table.classList.toggle('wide', getColumnCount(table) > 10);
        }
      
        function addColumn(table) {
          [...table.rows].forEach(tr => {
            const td = tr.insertCell(-1);
            if (tr.classList.contains('date-row')) {
              td.contentEditable = "false";
              td.addEventListener('click', stampNow);
            } else {
              td.contentEditable = "true";
              td.addEventListener('blur', debouncedSave);
            }
          });
          updateTableScroll(table);
        }
      
        function removeColumn(table) {
          if (getColumnCount(table) <= 1) return;
          [...table.rows].forEach(tr => tr.deleteCell(-1));
          updateTableScroll(table);
        }
      
        function addRow(table) {
          const cols = getColumnCount(table);
          const dateRow = getDateRow(table);
          const newRow = getTBody(table).insertRow(dateRow ? dateRow.rowIndex : -1);
          for (let i = 0; i < cols; i++) {
            const td = newRow.insertCell();
            td.contentEditable = "true";
            td.addEventListener('blur', debouncedSave);
          }
        }
      
        function removeRow(table) {
          const normalRows = [...table.querySelectorAll('tr:not(.date-row)')];
          if (normalRows.length <= 1) return;
          normalRows[normalRows.length - 1].remove();
        }
      
        function toggleGraph(table, canvas, graphWrap) {
          if (graphWrap.style.display === 'block') {
            graphWrap.style.display = 'none';
            return;
          }
          graphWrap.style.display = 'block';
          const normalRows = [...table.rows].filter(r => !r.classList.contains('date-row'));
          if (!normalRows.length) return;
          const colCount = normalRows[0].cells.length;
          let lastNonEmptyCol = -1;
          for (let c = colCount - 1; c >= 0; c--) {
              for (let r = 0; r < normalRows.length; r++) {
                  if (normalRows[r].cells[c] && !isNaN(parseFloat(normalRows[r].cells[c].textContent))) {
                      lastNonEmptyCol = c;
                      break;
                  }
              }
              if(lastNonEmptyCol !== -1) break;
          }
  
          if (lastNonEmptyCol === -1) return;
  
          const validCols = [];
          const labels = [];
          for (let c = 0; c <= lastNonEmptyCol; c++) {
            let hasNumber = false;
            for (let r = 0; r < normalRows.length; r++) {
              if (normalRows[r].cells[c] && !isNaN(parseFloat(normalRows[r].cells[c].textContent))) { hasNumber = true; break; }
            }
            if (hasNumber) {
                validCols.push(c);
                labels.push(`Col ${c + 1}`);
            }
          }
  
          if (!validCols.length) return;
  
          const datasets = [];
          normalRows.forEach((row, rIdx) => {
            const dataPoints = validCols.map(c => {
              const cell = row.cells[c];
              if (!cell) return null;
              const v = parseFloat(cell.textContent);
              return isNaN(v) ? null : v;
            });
  
            let firstValIndex = dataPoints.findIndex(p => p !== null);
            let lastValIndex = dataPoints.map(p => p !== null).lastIndexOf(true);
  
            if(firstValIndex === -1) return;
  
            const finalData = dataPoints.map((p, i) => (i >= firstValIndex && i <= lastValIndex) ? p : null);
            
            datasets.push({
              label: `Row ${rIdx + 1}`, data: finalData,
              borderColor: `hsl(${(rIdx * 60) % 360}, 70%, 50%)`,
              backgroundColor: `hsla(${(rIdx * 60) % 360}, 70%, 50%, .15)`,
              fill: false, spanGaps: false, tension: 0.2,
            });
          });
  
          if (canvas._chart) canvas._chart.destroy();
          canvas._chart = new Chart(canvas.getContext('2d'), {
            type: 'line', data: { labels, datasets },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
          });
        }
      
        function makeCaptionEditable(spanEl) {
          spanEl.style.cursor = 'text';
          spanEl.addEventListener('dblclick', (e) => { e.stopPropagation(); enableEdit(spanEl); });
          spanEl.setAttribute('tabindex', '0');
          spanEl.addEventListener('keydown', (e) => { if (e.key === 'F2') { e.preventDefault(); enableEdit(spanEl); } });
      
          function enableEdit(el) {
            el.contentEditable = 'true';
            el.classList.add('editing');
            el.focus();
            window.getSelection().selectAllChildren(el);
      
            function commit() {
              el.contentEditable = 'false';
              el.classList.remove('editing');
              cleanup();
              debouncedSave();
            }
            function onKey(e) { if (e.key === 'Enter' || e.key === 'Escape') { e.preventDefault(); commit(); } }
            function onBlur() { commit(); }
            function cleanup() {
              el.removeEventListener('keydown', onKey);
              el.removeEventListener('blur', onBlur);
            }
            el.addEventListener('keydown', onKey);
            el.addEventListener('blur', onBlur);
          }
        }
      
        // --- INITIALIZE APP ---
        loadStateFromFirebase();
      });
    
    </script>

</body>
</html>
